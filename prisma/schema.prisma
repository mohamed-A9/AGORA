generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model City {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  country   String   @default("Morocco")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  events    Event[]
  venues    Venue[]

}

model Country {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique // MA, FR, etc.
  dialCode  String   // +212, +33
  flag      String   // Emoji
  createdAt DateTime @default(now())
}

model User {
  id                         String    @id @default(cuid())
  name                       String?
  email                      String?   @unique
  emailVerified              DateTime?
  image                      String?
  password                   String?
  role                       String    @default("USER")
  phone                      String?
  birthday                   DateTime?
  gender                     String?
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  resetPasswordToken         String?   @unique
  resetPasswordExpiresAt     DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  accounts                   Account[]
  sessions                   Session[]
  reviews                    Review[]
  venues                     Venue[]
  preferredCities            String[]  @default([])
  preferredCategories        String[]  @default([])
  preferredAmbiances         String[]  @default([])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  venueId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId])
  @@index([userId])
}

model Venue {
  id                  String             @id @default(cuid())
  name                String
  slug                String             @unique
  description         String?
  mainCategory        MainCategory
  cityId              String?
  address             String?
  lat                 Float?
  lng                 Float?
  priceLevel          Int?
  phone               String?
  email               String?
  website             String?
  instagram           String?
  coverImageUrl       String?
  menuUrl             String?
  ownerId             String?
  isVerified          Boolean            @default(false)
  isActive            Boolean            @default(true)
  rating              Float              @default(0)
  numReviews          Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  locationUrl         String?
  wazeUrl             String?
  instagramUrl        String?
  tiktokUrl           String?
  reservationsEnabled Boolean            @default(true)
  status              String             @default("APPROVED")
  reservationPolicy   ReservationPolicy  @default(AGORA)
  reservationPhoneNumber String?
  reservationUrl       String?
  facebookUrl         String?
  openingHours        String?
  weeklySchedule      Json?
  floorPlan           Json?
  neighborhood        String?
  dressCode           String?
  agePolicy           String?
  paymentMethods      String[]           @default([])
  parkingAvailable    Boolean            @default(false)
  valetParking        Boolean            @default(false)
  events              Event[]
  reviews             Review[]
  reservations        Reservation[]
  city                City?              @relation(fields: [cityId], references: [id], onDelete: Restrict)
  owner               User?              @relation(fields: [ownerId], references: [id])
  cuisines            VenueCuisine[]
  facilities          VenueFacility[]
  gallery             VenueMedia[]
  musicTypes          VenueMusicType[]
  policies            VenuePolicy[]
  subcategories       VenueSubcategory[]
  tags                VenueTag[]
  vibes               VenueVibe[]
  wizardStep          Int?               @default(1)      // Track wizard progress

  @@index([cityId])
  @@index([mainCategory])
  @@index([priceLevel])
  @@index([ownerId])
  @@index([neighborhood])
  @@index([dressCode])
  @@index([agePolicy])
}

model VenueMedia {
  id        String   @id @default(cuid())
  venueId   String
  url       String
  kind      String   @default("image")
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId])
}

model Subcategory {
  id           String             @id @default(cuid())
  name         String
  slug         String             @unique
  mainCategory MainCategory
  createdAt    DateTime           @default(now())
  venues       VenueSubcategory[]

  @@unique([name, mainCategory])
  @@index([mainCategory])
}

model Cuisine {
  id        String         @id @default(cuid())
  name      String         @unique
  slug      String         @unique
  region    String?
  createdAt DateTime       @default(now())
  venues    VenueCuisine[]
}

model Vibe {
  id        String      @id @default(cuid())
  name      String
  slug      String      @unique
  createdAt DateTime    @default(now())
  events    EventVibe[]
  venues    VenueVibe[]
}

model MusicType {
  id        String           @id @default(cuid())
  name      String
  slug      String           @unique
  createdAt DateTime         @default(now())
  events    EventMusicType[]
  venues    VenueMusicType[]
}

model Policy {
  id        String        @id @default(cuid())
  code      String        @unique
  label     String
  createdAt DateTime      @default(now())
  venues    VenuePolicy[]
}

model Facility {
  id        String          @id @default(cuid())
  code      String          @unique
  label     String
  createdAt DateTime        @default(now())
  venues    VenueFacility[]
}

model Tag {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  createdAt DateTime   @default(now())
  events    EventTag[]
  venues    VenueTag[]
}

model Event {
  id             String           @id @default(cuid())
  title          String
  slug           String           @unique
  venueId        String?
  cityId         String
  startsAt       DateTime
  endsAt         DateTime?
  priceMin       Float?
  priceMax       Float?
  coverImageUrl  String?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  description    String?
  isTicketed     Boolean          @default(false)
  ticketingUrl   String?
  date           DateTime?
  ticketsEnabled Boolean          @default(false)
  type           String?
  city           City             @relation(fields: [cityId], references: [id])
  venue          Venue?           @relation(fields: [venueId], references: [id])
  media          EventMedia[]
  musicTypes     EventMusicType[]
  tags           EventTag[]
  vibes          EventVibe[]

  @@index([cityId, startsAt])
}

model EventMedia {
  id        String   @id @default(cuid())
  eventId   String
  url       String
  kind      String   @default("image")
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model VenueSubcategory {
  venueId       String
  subcategoryId String
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  venue         Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, subcategoryId])
  @@index([subcategoryId])
}

model VenueCuisine {
  venueId   String
  cuisineId String
  cuisine   Cuisine @relation(fields: [cuisineId], references: [id], onDelete: Cascade)
  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, cuisineId])
  @@index([cuisineId])
}

model VenueVibe {
  venueId String
  vibeId  String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  vibe    Vibe   @relation(fields: [vibeId], references: [id], onDelete: Cascade)

  @@id([venueId, vibeId])
  @@index([vibeId])
}

model VenueMusicType {
  venueId     String
  musicTypeId String
  musicType   MusicType @relation(fields: [musicTypeId], references: [id], onDelete: Cascade)
  venue       Venue     @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, musicTypeId])
  @@index([musicTypeId])
}

model VenuePolicy {
  venueId  String
  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  venue    Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, policyId])
  @@index([policyId])
}

model VenueFacility {
  venueId    String
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, facilityId])
  @@index([facilityId])
}

model VenueTag {
  venueId String
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([venueId, tagId])
  @@index([tagId])
}

model EventVibe {
  eventId String
  vibeId  String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vibe    Vibe   @relation(fields: [vibeId], references: [id], onDelete: Cascade)

  @@id([eventId, vibeId])
}

model EventMusicType {
  eventId     String
  musicTypeId String
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  musicType   MusicType @relation(fields: [musicTypeId], references: [id], onDelete: Cascade)

  @@id([eventId, musicTypeId])
}

model EventTag {
  eventId String
  tagId   String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
}


model Reservation {
  id        String   @id @default(cuid())
  date      DateTime
  time      String?
  partySize Int
  status    String   @default("PENDING")
  name      String
  email     String
  phone     String
  venueId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId])
}

enum MainCategory {
  CAFE
  RESTAURANT
  NIGHTLIFE_BARS
  CLUBS_PARTY
  EVENTS
  ACTIVITIES_FUN
  WELLNESS_HEALTH
}

enum ReservationPolicy {
  WALK_IN_ONLY
  PHONE_WHATSAPP
  EXTERNAL_LINK
  AGORA
}
